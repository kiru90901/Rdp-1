name: RDP x20 (Fixed Credentials)

on:
  workflow_dispatch:

jobs:
  create-rdp:
    name: RDP Instance ${{ matrix.instance }}
    runs-on: windows-latest
    timeout-minutes: 3600
    strategy:
      matrix:
        instance: [01, 02, 03, 04, 05, 06, 07, 08, 09, 10, 
                   11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
      max-parallel: 20   # सभी 20 jobs एक साथ चलेंगे

    env:
      FIXED_USER: RDP
      FIXED_PASS: "m}O57Y80DJ)gs>e+"

    steps:
      - name: Configure Core RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force

          netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>$null
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

          Restart-Service -Name TermService -Force

      - name: Create Fixed RDP User (Same on All Runners)
        run: |
          $user = "$env:FIXED_USER"
          $pass = ConvertTo-SecureString "$env:FIXED_PASS" -AsPlainText -Force

          # Remove user if already exists (idempotent)
          if (Get-LocalUser -Name $user -ErrorAction SilentlyContinue) {
              Remove-LocalUser -Name $user -Force
          }

          New-LocalUser -Name $user -Password $pass -FullName "RDP User" -Description "Fixed RDP Account" -AccountNeverExpires:$true -PasswordNeverExpires:$true
          Add-LocalGroupMember -Group "Administrators" -Member $user -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user

          Write-Host "Created user: $user with fixed password"

      - name: Install Tailscale
        run: |
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $path = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $url -OutFile $path
          Start-Process msiexec.exe -ArgumentList '/i', $path, '/quiet', '/norestart' -Wait
          Remove-Item $path -Force

      - name: Connect to Tailscale (Unique Hostname per Job)
        run: |
          \( hostname = "rdp- \){{ matrix.instance }}-${{ github.run_id }}"
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=$hostname --accept-risk=all

          # Wait for IP
          for ($i=0; $i -lt 20; $i++) {
              $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4 | Select-Object -First 1
              if ($ip) { break }
              Start-Sleep -Seconds 6
          }

          if (-not $ip) { Write-Error "Tailscale failed to get IP"; exit 1 }

          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "Tailscale connected → $ip (hostname: $hostname)"

      - name: Final Output & Keep Alive
        run: |
          Write-Host "============================================"
          Write-Host "RDP Instance ${{ matrix.instance }} READY"
          Write-Host "Address     → ${{ env.TAILSCALE_IP }}"
          Write-Host "Username    → ${{ env.FIXED_USER }}"
          Write-Host "Password    → ${{ env.FIXED_PASS }}"
          Write-Host "============================================"

          # Keep runner alive until manually cancelled
          while ($true) {
              Write-Host "[\( (Get-Date -Format 'HH:mm:ss')] Instance \){{ matrix.instance }} still alive - ${{ env.TAILSCALE_IP }}"
              Start-Sleep -Seconds 300
          }
